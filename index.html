<script>
const USERNAME = "cholose10";
const REPO = "Carta";
const FILE_PATH = "productos.json";
const BRANCH = "main";
let productos = [];

// Cargar productos desde GitHub
async function loadProducts() {
  const res = await fetch(`https://raw.githubusercontent.com/${USERNAME}/${REPO}/${BRANCH}/${FILE_PATH}`);
  productos = await res.json();
  renderTable();
}
loadProducts();

// Render tabla
function renderTable(filter = "") {
  const tbody = document.querySelector("#productsTable tbody");
  tbody.innerHTML = "";
  productos.forEach((p, index) => {
    if (p.nombre.toLowerCase().includes(filter.toLowerCase())) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><img src="${p.imagen}" alt="${p.nombre}"></td>
        <td>${p.nombre}</td>
        <td>${p.descripcion}</td>
        <td>$${p.precio}</td>
        <td>${p.categoria}</td>
        <td class="actions">
          <button class="editBtn" data-index="${index}">Editar</button>
          <button class="deleteBtn" data-index="${index}">Eliminar</button>
        </td>
      `;
      tbody.appendChild(tr);
    }
  });

  // Volvemos a asignar eventos a los botones
  document.querySelectorAll(".editBtn").forEach(btn => {
    btn.addEventListener("click", () => editProduct(btn.dataset.index));
  });
  document.querySelectorAll(".deleteBtn").forEach(btn => {
    btn.addEventListener("click", () => deleteProduct(btn.dataset.index));
  });
}

// Vista previa en vivo
["nombre","descripcion","precio","imagen"].forEach(id => {
  document.getElementById(id).addEventListener("input", updatePreview);
});
function updatePreview() {
  document.getElementById("previewImg").src = "img/" + document.getElementById("imagen").value;
  document.getElementById("previewNombre").textContent = document.getElementById("nombre").value;
  document.getElementById("previewDescripcion").textContent = document.getElementById("descripcion").value;
  document.getElementById("previewPrecio").textContent = "$" + document.getElementById("precio").value;
}

// Guardar producto (nuevo o editado)
document.getElementById("productForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  const index = document.getElementById("editIndex").value;
  const nuevo = {
    nombre: document.getElementById("nombre").value,
    descripcion: document.getElementById("descripcion").value,
    precio: document.getElementById("precio").value,
    imagen: "img/" + document.getElementById("imagen").value,
    categoria: document.getElementById("categoria").value
  };
  if (index === "") {
    productos.push(nuevo);
  } else {
    productos[index] = nuevo;
    document.getElementById("editIndex").value = "";
  }
  await saveToGitHub();
  renderTable(document.getElementById("searchBox").value);
  this.reset();
  updatePreview();
});

// Editar producto
function editProduct(index) {
  const p = productos[index];
  document.getElementById("nombre").value = p.nombre;
  document.getElementById("descripcion").value = p.descripcion;
  document.getElementById("precio").value = p.precio;
  document.getElementById("imagen").value = p.imagen.replace("img/","");
  document.getElementById("categoria").value = p.categoria;
  document.getElementById("editIndex").value = index;
  updatePreview();
}

// Eliminar producto
async function deleteProduct(index) {
  if (confirm("¿Eliminar este producto?")) {
    productos.splice(index,1);
    await saveToGitHub();
    renderTable(document.getElementById("searchBox").value);
  }
}

// Guardar en GitHub
async function saveToGitHub() {
  const token = document.getElementById("tokenInput").value.trim();
  if (!token) {
    alert("⚠️ Ingresá tu token de GitHub antes de guardar.");
    return;
  }
  const getRes = await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${FILE_PATH}`);
  const fileData = await getRes.json();
  const sha = fileData.sha;
  const content = btoa(unescape(encodeURIComponent(JSON.stringify(productos, null, 2))));
  
  await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${FILE_PATH}`, {
    method: "PUT",
    headers: {
      "Authorization": `token ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: "Actualizar productos",
      content: content,
      sha: sha,
      branch: BRANCH
    })
  });
}

// Buscador en vivo
document.getElementById("searchBox").addEventListener("input", (e) => {
  renderTable(e.target.value);
});
</script>

