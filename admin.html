<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Admin - Carta Tilo Café</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    h1 { color: #5a3e2b; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #e3d5ca; }
    img { max-width: 60px; border-radius: 6px; }
    input, select, button { margin: 5px; padding: 6px; }
    .form-container { background: #fff; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
    .preview { margin-top: 10px; padding: 10px; border: 1px solid #ccc; background: #fafafa; }
  </style>
</head>
<body>
  <h1>Administración - Carta Tilo Café</h1>

  <!-- Buscador -->
  <input type="text" id="buscador" placeholder="Buscar producto..." onkeyup="buscarProducto(this.value)">

  <!-- Formulario -->
  <div class="form-container">
    <h3>Agregar / Editar Producto</h3>
    <input type="text" id="nombre" placeholder="Nombre"><br>
    <input type="text" id="descripcion" placeholder="Descripción"><br>
    <input type="text" id="categoria" placeholder="Categoría"><br>
    <input type="number" id="precio" placeholder="Precio"><br>
    <input type="text" id="imagen" placeholder="Archivo imagen (ej: cafe.jpg)"><br>
    <button onclick="guardarCambios()">Guardar</button>
    <button onclick="resetForm()">Limpiar</button>

    <!-- Vista previa -->
    <div class="preview" id="preview"></div>
  </div>

  <!-- Botones Excel -->
  <button onclick="exportarExcel()">Exportar Excel</button>
  <input type="file" id="importarExcel" accept=".xlsx" onchange="importarExcel(event)">

  <!-- Tabla productos -->
  <table id="tablaProductos">
    <thead>
      <tr>
        <th>Imagen</th>
        <th>Nombre</th>
        <th>Descripción</th>
        <th>Categoría</th>
        <th>Precio</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let productos = [];
    let editIndex = null;

    // Cargar productos.json
    fetch("productos.json")
      .then(r => r.json())
      .then(data => {
        productos = data;
        renderTabla(productos.map((p,i)=>({...p,_id:i})));
      });

    // Renderizar tabla
    function renderTabla(lista) {
      const tbody = document.querySelector("#tablaProductos tbody");
      tbody.innerHTML = "";
      lista.forEach(prod => {
        const fila = document.createElement("tr");
        fila.innerHTML = `
          <td><img src="img/${prod.imagen}" alt="${prod.nombre}"></td>
          <td>${prod.nombre}</td>
          <td>${prod.descripcion}</td>
          <td>${prod.categoria}</td>
          <td>${prod.precio}</td>
          <td>
            <button onclick="editarProducto(${prod._id})">Editar</button>
            <button onclick="eliminarProducto(${prod._id})">Eliminar</button>
          </td>
        `;
        tbody.appendChild(fila);
      });
    }

    // Buscar producto
    function buscarProducto(termino) {
      termino = termino.toLowerCase();
      const filtrados = productos
        .map((p,i)=>({...p,_id:i}))
        .filter(p =>
          p.nombre.toLowerCase().includes(termino) ||
          p.categoria.toLowerCase().includes(termino)
        );
      renderTabla(filtrados);
    }

    // Editar producto
    function editarProducto(id) {
      const producto = productos[id];
      if (!producto) return;

      document.getElementById("nombre").value = producto.nombre;
      document.getElementById("descripcion").value = producto.descripcion;
      document.getElementById("categoria").value = producto.categoria;
      document.getElementById("precio").value = producto.precio;
      document.getElementById("imagen").value = producto.imagen;

      editIndex = id;
      actualizarPreview();
    }

    // Eliminar producto
    function eliminarProducto(id) {
      if (confirm("¿Seguro que deseas eliminar este producto?")) {
        productos.splice(id,1);
        renderTabla(productos.map((p,i)=>({...p,_id:i})));
      }
    }

    // Guardar cambios
    function guardarCambios() {
      const nuevo = {
        nombre: document.getElementById("nombre").value,
        descripcion: document.getElementById("descripcion").value,
        categoria: document.getElementById("categoria").value,
        precio: document.getElementById("precio").value,
        imagen: document.getElementById("imagen").value
      };

      if (editIndex !== null) {
        productos[editIndex] = nuevo; // editar
        editIndex = null;
      } else {
        productos.push(nuevo); // agregar
      }

      renderTabla(productos.map((p,i)=>({...p,_id:i})));
      resetForm();
    }

    // Reset formulario
    function resetForm() {
      document.getElementById("nombre").value = "";
      document.getElementById("descripcion").value = "";
      document.getElementById("categoria").value = "";
      document.getElementById("precio").value = "";
      document.getElementById("imagen").value = "";
      document.getElementById("preview").innerHTML = "";
      editIndex = null;
    }

    // Vista previa
    function actualizarPreview() {
      const nombre = document.getElementById("nombre").value;
      const descripcion = document.getElementById("descripcion").value;
      const categoria = document.getElementById("categoria").value;
      const precio = document.getElementById("precio").value;
      const imagen = document.getElementById("imagen").value;

      document.getElementById("preview").innerHTML = `
        <strong>Vista previa:</strong><br>
        <img src="img/${imagen}" width="80"><br>
        ${nombre} - ${descripcion}<br>
        <em>${categoria}</em> | $${precio}
      `;
    }

    document.querySelectorAll("#nombre, #descripcion, #categoria, #precio, #imagen")
      .forEach(el => el.addEventListener("input", actualizarPreview));

    // Exportar Excel
    function exportarExcel() {
      const hoja = XLSX.utils.json_to_sheet(productos);
      const libro = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(libro, hoja, "Carta");
      XLSX.writeFile(libro, "carta_tilo.xlsx");
    }

    // Importar Excel
    function importarExcel(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function(event) {
        const data = new Uint8Array(event.target.result);
        const libro = XLSX.read(data, { type: "array" });
        const hoja = libro.Sheets[libro.SheetNames[0]];
        productos = XLSX.utils.sheet_to_json(hoja);
        renderTabla(productos.map((p,i)=>({...p,_id:i})));
      };
      reader.readAsArrayBuffer(file);
    }
  </script>
</body>
</html>
