<script>
  let productos = [];
  let ordenAsc = true;

  const form = document.getElementById("formProducto");
  const tabla = document.querySelector("#tabla tbody");
  const editIndex = document.getElementById("editIndex");

  // ✅ Guardar producto
  form.addEventListener("submit", e => {
    e.preventDefault();
    const producto = {
      nombre: document.getElementById("nombre").value.trim(),
      descripcion: document.getElementById("descripcion").value.trim(),
      categoria: document.getElementById("categoria").value.trim(),
      precio: parseFloat(document.getElementById("precio").value)
    };

    if(editIndex.value === "") {
      // Nuevo → Evitar duplicado por nombre
      const idx = productos.findIndex(p => p.nombre.toLowerCase() === producto.nombre.toLowerCase());
      if(idx !== -1){
        productos[idx] = producto; // lo actualiza
      } else {
        productos.push(producto); // lo agrega
      }
    } else {
      productos[editIndex.value] = producto; // Editar sin duplicar
      editIndex.value = "";
    }

    form.reset();
    mostrarProductos();
  });

  // ✅ Mostrar productos
  function mostrarProductos(lista = productos) {
    tabla.innerHTML = "";
    lista.forEach((p, i) => {
      const fila = `
        <tr>
          <td>${p.nombre}</td>
          <td>${p.descripcion}</td>
          <td>${p.categoria}</td>
          <td>$${p.precio.toFixed(2)}</td>
          <td>
            <button onclick="editarProducto(${i})">Editar</button>
            <button onclick="eliminarProducto(${i})">Eliminar</button>
          </td>
        </tr>`;
      tabla.innerHTML += fila;
    });
  }

  // ✅ Editar
  function editarProducto(i) {
    const p = productos[i];
    document.getElementById("nombre").value = p.nombre;
    document.getElementById("descripcion").value = p.descripcion;
    document.getElementById("categoria").value = p.categoria;
    document.getElementById("precio").value = p.precio;
    editIndex.value = i;
  }

  // ✅ Eliminar (funciona incluso si hay filtros)
  function eliminarProducto(i) {
    productos.splice(i, 1);
    mostrarProductos();
  }

  // ✅ Importar Excel sin duplicados
  function importarExcel(e) {
    const archivo = e.target.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
      const data = new Uint8Array(e.target.result);
      const libro = XLSX.read(data, {type: "array"});
      const hoja = libro.Sheets[libro.SheetNames[0]];
      const nuevos = XLSX.utils.sheet_to_json(hoja);

      nuevos.forEach(nuevo => {
        const idx = productos.findIndex(p => p.nombre.toLowerCase() === nuevo.nombre.toLowerCase());
        if(idx !== -1){
          productos[idx] = nuevo; // Actualiza existente
        } else {
          productos.push(nuevo); // Agrega si no existe
        }
      });

      mostrarProductos();
    };
    reader.readAsArrayBuffer(archivo);
  }
</script>
