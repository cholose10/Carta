<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Admin GitHub - Tilo Caf√©</title>
  <style>
    body { font-family: sans-serif; background: #fffafa; padding: 20px; color: #333; }
    input, textarea, select, button { display: block; margin: 10px 0; padding: 10px; width: 100%; max-width: 500px; }
    button { background: #68310f; color: white; border: none; border-radius: 8px; cursor: pointer; }
    button:hover { background: #4c2812; }
    .preview { border: 1px solid #ccc; border-radius: 10px; padding: 10px; margin-top: 20px; background: #f7f7f7; width: 100%; max-width: 500px; }
    .preview img { width: 100%; max-height: 200px; object-fit: cover; }
    label { font-weight: bold; }
  </style>
</head>
<body>
  <h1>üìã Administrador de productos - Tilo Caf√©</h1>

  <label>Nombre</label>
  <input type="text" id="nombre">

  <label>Descripci√≥n</label>
  <textarea id="descripcion"></textarea>

  <label>Precio (solo n√∫mero)</label>
  <input type="number" id="precio" min="0">

  <label>Nombre de la imagen (ej: cafe1.jpg)</label>
  <input type="text" id="imagen">

  <label>Categor√≠a</label>
  <select id="categoria">
    <option value="">Cargando categor√≠as...</option>
  </select>
  <input type="text" id="nueva-categoria" placeholder="Otra categor√≠a..." style="display:none;"/>

  <button onclick="agregarProducto()">Agregar producto</button>

  <label style="margin-top:30px;">üîë Token GitHub (privado)</label>
  <input type="password" id="token">

  <button onclick="guardarEnGitHub()">üöÄ Guardar en GitHub</button>

  <div class="preview" id="preview" style="display:none;">
    <h2>Vista previa</h2>
    <img id="preview-img">
    <h3 id="preview-nombre"></h3>
    <p id="preview-descripcion"></p>
    <p id="preview-precio" style="font-weight:bold;"></p>
  </div>

  <script>
    let productos = [];

    async function cargarCategorias() {
      const token = localStorage.getItem("githubToken") || "";
      const res = await fetch("https://api.github.com/repos/cholose10/Carta/contents/productos.json", {
        headers: { Authorization: "token " + token }
      });
      const data = await res.json();
      if (!data.content) return;

      const json = JSON.parse(atob(data.content));
      productos = json;

      const categoriasUnicas = [...new Set(json.map(p => p.categoria))].sort();

      const select = document.getElementById("categoria");
      select.innerHTML = categoriasUnicas.map(cat => `<option value="${cat}">${cat}</option>`).join("");
      select.innerHTML += '<option value="otra">‚ûï Otra (escribir nueva)</option>';
    }

    document.getElementById("categoria").addEventListener("change", function() {
      document.getElementById("nueva-categoria").style.display = this.value === "otra" ? "block" : "none";
    });

    function agregarProducto() {
      let categoria = document.getElementById("categoria").value;
      if (categoria === "otra") {
        categoria = document.getElementById("nueva-categoria").value.trim();
        if (!categoria) return alert("Debes escribir la nueva categor√≠a.");
        categoria = categoria.charAt(0).toUpperCase() + categoria.slice(1).toLowerCase();
      }

      const nombre = document.getElementById("nombre").value;
      const descripcion = document.getElementById("descripcion").value;
      const precio = "$" + document.getElementById("precio").value;
      const imagen = "img/" + document.getElementById("imagen").value;

      const nuevo = { nombre, descripcion, precio, imagen, categoria };
      productos.push(nuevo);

      // Mostrar vista previa
      document.getElementById("preview").style.display = "block";
      document.getElementById("preview-img").src = imagen;
      document.getElementById("preview-nombre").innerText = nombre;
      document.getElementById("preview-descripcion").innerText = descripcion;
      document.getElementById("preview-precio").innerText = precio;

      document.getElementById("nombre").value = "";
      document.getElementById("descripcion").value = "";
      document.getElementById("precio").value = "";
      document.getElementById("imagen").value = "";
      document.getElementById("nueva-categoria").value = "";
      document.getElementById("nueva-categoria").style.display = "none";
      document.getElementById("categoria").selectedIndex = 0;
    }

    async function guardarEnGitHub() {
      const token = document.getElementById("token").value;
      if (!token) return alert("Peg√° tu token privado de GitHub");
      localStorage.setItem("githubToken", token);

      const owner = "cholose10";
      const repo = "Carta";
      const path = "productos.json";
      const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;

      const response = await fetch(apiUrl, {
        headers: { Authorization: `token ${token}` }
      });
      const data = await response.json();
      const sha = data.sha;

      const content = btoa(unescape(encodeURIComponent(JSON.stringify(productos, null, 2))));

      const commit = await fetch(apiUrl, {
        method: "PUT",
        headers: {
          Authorization: `token ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: "Actualizaci√≥n desde admin con select de categor√≠as",
          content,
          sha,
          branch: "main"
        })
      });

      if (commit.ok) {
        alert("‚úÖ Archivo productos.json actualizado en GitHub.");
      } else {
        alert("‚ùå Error al subir a GitHub.");
      }
    }

    cargarCategorias();
  </script>
</body>
</html>
