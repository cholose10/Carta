<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin Carta Tilo Café</title>

<!-- Librerías para exportar -->
<!-- jsPDF + autotable -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<style>
  :root{
    --bg:#f7f3f0; --ink:#5a3825; --pri:#8c6954; --pri-dark:#6b4e3d; --card:#ffffff;
    --ok:#1b8f48; --err:#b42222;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,Segoe UI,Arial,sans-serif;margin:0;background:#f6f6f6;color:var(--ink)}
  header{background:var(--pri);color:#fff;padding:14px 18px}
  header h1{margin:0;font-size:1.25rem}
  main{max-width:1100px;margin:18px auto;padding:0 14px}
  .panel{background:var(--card);border-radius:12px;box-shadow:0 3px 16px rgba(0,0,0,.06);padding:14px;margin-bottom:16px}
  .grid{display:grid;gap:12px}
  .g2{grid-template-columns:repeat(2,1fr)}
  .g3{grid-template-columns:repeat(3,1fr)}
  @media (max-width:840px){.g2,.g3{grid-template-columns:1fr}}
  label{font-size:.9rem;color:#3d281b}
  input,textarea,select,button{
    width:100%;padding:10px;border:1px solid #d5c8be;border-radius:10px;background:#fff;font-size:1rem
  }
  textarea{min-height:80px;resize:vertical}
  button{background:var(--pri);color:#fff;border:none;cursor:pointer}
  button:hover{background:var(--pri-dark)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row > *{flex:1}
  .hint{font-size:.85rem;color:#6a6a6a}
  .muted{opacity:.8}
  .danger{background:#fff1f1;border:1px solid #f0c9c9}
  .ok{color:var(--ok)}
  .err{color:var(--err)}
  .actions button{margin-right:6px;margin-bottom:6px;width:auto;padding:6px 10px}
  .badge{display:inline-block;background:#efe7e2;padding:2px 8px;border-radius:999px;font-size:.8rem}
  .preview{display:flex;gap:14px;align-items:flex-start}
  .preview img{width:120px;height:80px;object-fit:cover;border-radius:8px;border:1px solid #ddd}
  table{width:100%;border-collapse:collapse}
  thead th{position:sticky;top:0;background:#f0e7e1;border-bottom:2px solid #e0d5cf;padding:10px;text-align:left;font-weight:600}
  tbody td{border-bottom:1px solid #eee;padding:8px;vertical-align:top}
  tbody tr:hover{background:#faf7f5}
  .th-btn{cursor:pointer;user-select:none}
  .th-btn small{opacity:.7}
  .img-cell img{width:60px;height:40px;object-fit:cover;border-radius:6px;border:1px solid #ddd}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
  .tool{flex:1;min-width:180px}
  .tool button{width:auto}
  footer{color:#876b5a;text-align:center;padding:24px 10px}
</style>
</head>
<body>
<header><h1>Admin — Carta Tilo Café</h1></header>

<main>
  <!-- Configuración GitHub -->
  <section class="panel">
    <h2 style="margin-top:0">Conexión a GitHub</h2>
    <div class="grid g3">
      <div>
        <label for="ghUser">Usuario/Org</label>
        <input id="ghUser" value="cholose10"/>
      </div>
      <div>
        <label for="ghRepo">Repositorio</label>
        <input id="ghRepo" value="Carta"/>
      </div>
      <div>
        <label for="ghBranch">Rama</label>
        <input id="ghBranch" value="main"/>
      </div>
      <div>
        <label for="ghPath">Ruta del archivo</label>
        <input id="ghPath" value="productos.json"/>
      </div>
      <div>
        <label for="ghToken">Token (se guarda sólo en esta pestaña)</label>
        <input id="ghToken" type="password" placeholder="Pegá tu token personal aquí"/>
        <div class="hint">No se envía a ningún servidor salvo a GitHub cuando guardás.</div>
      </div>
      <div class="tool">
        <button id="btnSaveToken">Guardar token en esta pestaña</button>
        <button id="btnClearToken" style="background:#a34d3b">Borrar token</button>
      </div>
    </div>
    <div id="connMsg" class="hint" style="margin-top:6px"></div>
  </section>

  <!-- Formulario producto -->
  <section class="panel">
    <h2 style="margin-top:0">Producto</h2>
    <form id="productForm">
      <input type="hidden" id="editId" value="">
      <div class="grid g2">
        <div>
          <label>Nombre</label>
          <input id="nombre" required />
        </div>
        <div>
          <label>Precio (solo número)</label>
          <input id="precio" type="number" step="1" min="0" required />
        </div>
        <div>
          <label>Imagen (solo archivo, ej: cafe.jpg)</label>
          <input id="imagen" placeholder="cafe.jpg" required />
        </div>
        <div>
          <label>Categoría</label>
          <input id="categoria" placeholder="Ej: Cafetería" required />
        </div>
        <div class="grid" style="grid-template-columns:1fr">
          <label>Descripción</label>
          <textarea id="descripcion" required></textarea>
        </div>
      </div>
      <div class="preview" style="margin-top:10px">
        <img id="previewImg" src="" alt="Vista previa"/>
        <div>
          <div><strong id="previewNombre">—</strong> <span class="badge" id="previewCategoria"></span></div>
          <div id="previewDescripcion" class="muted">—</div>
          <div id="previewPrecio" style="margin-top:6px"><strong>$0</strong></div>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button type="submit" id="btnSubmit">Guardar producto</button>
        <button type="button" id="btnCancelEdit" style="display:none;background:#a34d3b">Cancelar edición</button>
      </div>
    </form>
  </section>

  <!-- Herramientas de búsqueda / exportación -->
  <section class="panel">
    <div class="toolbar">
      <div class="tool">
        <label>Buscar por nombre (plato)</label>
        <input id="searchName" placeholder="Escribí parte del nombre…" />
      </div>
      <div class="tool">
        <label>Filtrar por categoría</label>
        <select id="searchCat">
          <option value="">Todas</option>
        </select>
      </div>
      <div class="tool" style="display:flex;gap:10px">
        <button id="btnReset">Reset búsqueda</button>
      </div>
      <div class="tool" style="display:flex;gap:10px">
        <button id="btnExportPDF">Exportar PDF (img 100px)</button>
        <button id="btnExportXLS">Exportar Excel (con imágenes)</button>
      </div>
    </div>
  </section>

  <!-- Tabla -->
  <section class="panel">
    <h2 style="margin-top:0">Productos actuales</h2>
    <div class="hint">Tip: hacé clic en “Categoría” o “Precio” para ordenar.</div>
    <div style="overflow:auto">
      <table id="productsTable">
        <thead>
          <tr>
            <th>Imagen</th>
            <th>Nombre</th>
            <th class="th-btn" data-sort="categoria">Categoría <small id="sortCat">↕</small></th>
            <th>Descripción</th>
            <th class="th-btn" data-sort="precio">Precio <small id="sortPrice">↕</small></th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <footer>
    Hecho con ☕ en Tilo Café — Admin de carta con GitHub
  </footer>
</main>

<script>
/* ========== Estado global ========== */
const state = {
  productos: [],       // lista completa
  view: [],            // lista filtrada/ordenada para la tabla
  sort: { key:null, dir: 1 }, // 1 asc, -1 desc
  imgsCache: new Map() // cache de dataURL para PDF
};

/* ========== Utilidades ========== */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

function moneyToNumber(v){
  // convierte "$12.300" o "12300" a número 12300
  if (typeof v === 'number') return v;
  if (!v) return 0;
  return Number(String(v).replace(/[^\d]/g,'') || 0);
}
function numberToMoney(n){
  n = moneyToNumber(n);
  return "$" + n.toLocaleString('es-AR');
}
function uid(){
  return 'p_' + Math.random().toString(36).slice(2,10);
}

/* ========== Token en sessionStorage ========== */
const tokenInput = $('#ghToken');
$('#btnSaveToken').onclick = ()=>{
  sessionStorage.setItem('gh.token', tokenInput.value.trim());
  msg('Token guardado en esta pestaña.', 'ok');
};
$('#btnClearToken').onclick = ()=>{
  sessionStorage.removeItem('gh.token');
  tokenInput.value = '';
  msg('Token eliminado de esta pestaña.', 'ok');
};
tokenInput.value = sessionStorage.getItem('gh.token') || '';

function msg(text, kind=''){
  const el = $('#connMsg');
  el.textContent = text;
  el.className = 'hint ' + (kind==='ok'?'ok': kind==='err'?'err':'');
}

/* ========== Config GH getters ========== */
function cfg(){
  return {
    user: $('#ghUser').value.trim(),
    repo: $('#ghRepo').value.trim(),
    branch: $('#ghBranch').value.trim(),
    path: $('#ghPath').value.trim(),
    token: sessionStorage.getItem('gh.token') || ''
  };
}

/* ========== Carga inicial ========== */
(async function init(){
  await loadProducts();
  hookUI();
})();

/* ========== Cargar productos desde raw ========== */
async function loadProducts(){
  const {user,repo,branch,path} = cfg();
  const url = `https://raw.githubusercontent.com/${user}/${repo}/${branch}/${path}?t=${Date.now()}`;
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error('No se pudo leer productos.json');
    let data = await res.json();
    // Asegurar id y normalizar precio como número y ruta imagen prefijada
    data = data.map(p=>{
      const withId = {...p};
      if(!withId.id) withId.id = uid();
      withId.precio = moneyToNumber(withId.precio);
      // si ya viene con "img/" lo respetamos; si no, lo agregamos
      if (withId.imagen && !/^img\//.test(withId.imagen)) {
        withId.imagen = 'img/' + String(withId.imagen).replace(/^img\//,'');
      }
      return withId;
    });
    state.productos = data;
    buildCategorySelect();
    applyFilters(); // rellena state.view y dibuja
    msg('Productos cargados.');
  }catch(e){
    console.error(e);
    msg('Error al cargar productos: ' + e.message, 'err');
  }
}

/* ========== Guardar en GitHub ========== */
async function saveToGitHub(newList){
  const {user,repo,path,branch,token} = cfg();
  if(!token){ msg('Necesitás pegar tu token para guardar.', 'err'); throw new Error('Sin token'); }

  // 1) Obtener SHA actual
  const metaURL = `https://api.github.com/repos/${user}/${repo}/contents/${path}?ref=${branch}`;
  const metaRes = await fetch(metaURL);
  if(!metaRes.ok) { msg('No se pudo leer metadata del archivo.', 'err'); throw new Error('Meta error'); }
  const meta = await metaRes.json();

  // 2) Preparar contenido
  // Convertimos precio a string con $ para guardar igual que la carta espera
  const exportList = newList.map(p => ({
    nombre: p.nombre,
    descripcion: p.descripcion,
    precio: numberToMoney(p.precio),
    imagen: p.imagen,
    categoria: p.categoria,
    id: p.id
  }));
  const content = btoa(unescape(encodeURIComponent(JSON.stringify(exportList, null, 2))));

  // 3) PUT
  const putURL = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;
  const putRes = await fetch(putURL, {
    method:'PUT',
    headers:{
      'Authorization': `token ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      message: 'Actualizar productos desde admin',
      content,
      sha: meta.sha,
      branch
    })
  });

  if(!putRes.ok){
    const tx = await putRes.text();
    console.error(tx);
    msg('Error al guardar en GitHub (revisá permisos/token).', 'err');
    throw new Error('PUT error');
  }
  msg('Cambios guardados en GitHub ✅', 'ok');
}

/* ========== Render tabla ========== */
function renderTable(){
  const tbody = $('#productsTable tbody');
  tbody.innerHTML = '';
  state.view.forEach((p) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="img-cell"><img src="${p.imagen}" alt="${p.nombre}"/></td>
      <td>${p.nombre}</td>
      <td><span class="badge">${p.categoria}</span></td>
      <td>${p.descripcion}</td>
      <td><strong>${numberToMoney(p.precio)}</strong></td>
      <td class="actions">
        <button data-act="edit" data-id="${p.id}">Editar</button>
        <button data-act="del" data-id="${p.id}" style="background:#a34d3b">Eliminar</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ========== Búsqueda/filtrado/orden ========== */
function buildCategorySelect(){
  const sel = $('#searchCat');
  const cats = Array.from(new Set(state.productos.map(p=>p.categoria).filter(Boolean))).sort();
  sel.innerHTML = '<option value="">Todas</option>' + cats.map(c=>`<option>${c}</option>`).join('');
}

function applyFilters(){
  const q = $('#searchName').value.trim().toLowerCase();
  const c = $('#searchCat').value.trim();
  let list = state.productos.filter(p=>{
    const okName = !q || p.nombre.toLowerCase().includes(q);
    const okCat  = !c || p.categoria === c;
    return okName && okCat;
  });

  // ordenar si corresponde
  if(state.sort.key){
    const k = state.sort.key, d = state.sort.dir;
    list.sort((a,b)=>{
      if(k==='precio') return (a.precio - b.precio) * d;
      if(k==='categoria') return a.categoria.localeCompare(b.categoria) * d;
      return 0;
    });
  }
  state.view = list;
  renderTable();
}

function toggleSort(key){
  if(state.sort.key !== key){
    state.sort.key = key; state.sort.dir = 1;
  }else{
    state.sort.dir = state.sort.dir * -1;
  }
  // actualizar indicadores
  $('#sortCat').textContent   = state.sort.key==='categoria' ? (state.sort.dir>0?'↑':'↓') : '↕';
  $('#sortPrice').textContent = state.sort.key==='precio'    ? (state.sort.dir>0?'↑':'↓') : '↕';
  applyFilters();
}

/* ========== Edición / Eliminación con ID ========== */
function startEditById(id){
  const p = state.productos.find(x=>x.id===id);
  if(!p) return;
  $('#editId').value = p.id;
  $('#nombre').value = p.nombre;
  $('#descripcion').value = p.descripcion;
  $('#precio').value = moneyToNumber(p.precio);
  $('#imagen').value = (p.imagen||'').replace(/^img\//,'');
  $('#categoria').value = p.categoria || '';
  updatePreview();
  $('#btnSubmit').textContent = 'Guardar cambios';
  $('#btnCancelEdit').style.display = 'inline-block';
  window.scrollTo({top:0,behavior:'smooth'});
}
async function deleteById(id){
  if(!confirm('¿Eliminar este producto?')) return;
  const idx = state.productos.findIndex(x=>x.id===id);
  if(idx<0) return;
  state.productos.splice(idx,1);
  try{
    await saveToGitHub(state.productos);
    applyFilters();
  }catch(e){}
}

/* ========== Vista previa ========== */
function updatePreview(){
  const img = $('#imagen').value.trim();
  $('#previewImg').src = img ? ('img/' + img) : '';
  $('#previewNombre').textContent = $('#nombre').value.trim() || '—';
  $('#previewCategoria').textContent = $('#categoria').value.trim() || '';
  $('#previewDescripcion').textContent = $('#descripcion').value.trim() || '—';
  $('#previewPrecio').innerHTML = '<strong>' + numberToMoney($('#precio').value) + '</strong>';
}
['#nombre','#descripcion','#precio','#imagen','#categoria'].forEach(sel=>{
  $(sel).addEventListener('input', updatePreview);
});

/* ========== Handlers UI ========== */
function hookUI(){
  // tabla: delegación de eventos
  $('#productsTable').addEventListener('click', (e)=>{
    const b = e.target.closest('button'); if(!b) return;
    const id = b.getAttribute('data-id'); const act = b.getAttribute('data-act');
    if(act==='edit') startEditById(id);
    if(act==='del')  deleteById(id);
  });

  // ordenar
  $$('.th-btn').forEach(th=>{
    th.addEventListener('click', ()=>toggleSort(th.getAttribute('data-sort')));
  });

  // buscar / filtrar
  $('#searchName').addEventListener('input', applyFilters);
  $('#searchCat').addEventListener('change', applyFilters);
  $('#btnReset').addEventListener('click', ()=>{
    $('#searchName').value=''; $('#searchCat').value='';
    state.sort = {key:null,dir:1};
    $('#sortCat').textContent='↕'; $('#sortPrice').textContent='↕';
    applyFilters();
  });

  // cancelar edición
  $('#btnCancelEdit').onclick = ()=>{
    $('#productForm').reset();
    $('#editId').value='';
    $('#btnSubmit').textContent='Guardar producto';
    $('#btnCancelEdit').style.display='none';
    updatePreview();
  };

  // submit
  $('#productForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const id = $('#editId').value;
    const nuevo = {
      id: id || uid(),
      nombre: $('#nombre').value.trim(),
      descripcion: $('#descripcion').value.trim(),
      precio: moneyToNumber($('#precio').value),
      imagen: 'img/' + $('#imagen').value.trim().replace(/^img\//,''),
      categoria: $('#categoria').value.trim()
    };
    if(!nuevo.nombre || !nuevo.descripcion || !nuevo.categoria){
      msg('Completá todos los campos.', 'err'); return;
    }
    if(id){
      const i = state.productos.findIndex(x=>x.id===id);
      if(i>=0) state.productos[i]=nuevo;
    }else{
      state.productos.push(nuevo);
    }
    try{
      await saveToGitHub(state.productos);
      // limpiar form
      $('#productForm').reset(); $('#editId').value='';
      $('#btnSubmit').textContent='Guardar producto';
      $('#btnCancelEdit').style.display='none';
      updatePreview();
      // refrescar lista
      buildCategorySelect();
      applyFilters();
    }catch(e){}
  });

  // export
  $('#btnExportPDF').onclick = exportPDF;
  $('#btnExportXLS').onclick = exportExcel;

  // previsual inicial
  updatePreview();
}

/* ========== Exportar PDF (con imágenes 100px) ========== */
async function exportPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4'});
  const margin = 36;
  const cellImgW = 100, cellImgH = 100;

  // Preprocesar filas
  const rows = [];
  for (const p of state.view.length ? state.view : state.productos){
    const imgData = await getImageDataURL(p.imagen);
    rows.push({
      img: imgData,
      nombre: p.nombre,
      categoria: p.categoria,
      descripcion: p.descripcion,
      precio: numberToMoney(p.precio)
    });
  }

  doc.setFontSize(14);
  doc.text('Carta Tilo Café — Exportación', margin, margin);
  doc.setFontSize(10);
  doc.text(new Date().toLocaleString(), margin, margin+14);

  doc.autoTable({
    startY: margin+24,
    head: [['Imagen','Nombre','Categoría','Descripción','Precio']],
    body: rows.map(r => ['', r.nombre, r.categoria, r.descripcion, r.precio]),
    styles: { fontSize: 9, cellPadding: 6, valign:'middle' },
    columnStyles:{
      0:{ cellWidth: cellImgW + 10 },
      1:{ cellWidth: 120 },
      2:{ cellWidth: 110 },
      3:{ cellWidth: 210 },
      4:{ cellWidth: 70, halign:'right' }
    },
    didDrawCell: function(data){
      if (data.section === 'body' && data.column.index === 0){
        const r = rows[data.row.index];
        if(r.img){
          const x = data.cell.x + 5;
          const y = data.cell.y + 5;
          doc.addImage(r.img, 'JPEG', x, y, cellImgW, cellImgH);
        }
      }
    }
  });

  doc.save('carta_tilo.pdf');
}

// Cargar imagen a dataURL (con cache)
function getImageDataURL(url){
  if(state.imgsCache.has(url)) return Promise.resolve(state.imgsCache.get(url));
  return new Promise(resolve=>{
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = function(){
      const cv = document.createElement('canvas');
      const w = 300, h = 200; // tamaño razonable para convertir
      cv.width = w; cv.height = h;
      const ctx = cv.getContext('2d');
      ctx.fillStyle = '#fff'; ctx.fillRect(0,0,w,h);
      // Ajustar manteniendo proporción
      const ratio = Math.min(w/img.naturalWidth, h/img.naturalHeight);
      const dw = img.naturalWidth * ratio;
      const dh = img.naturalHeight * ratio;
      const dx = (w - dw)/2, dy=(h - dh)/2;
      ctx.drawImage(img, dx, dy, dw, dh);
      const data = cv.toDataURL('image/jpeg', 0.8);
      state.imgsCache.set(url, data);
      resolve(data);
    };
    img.onerror = ()=>resolve(null);
    img.src = url;
  });
}

/* ========== Exportar Excel (.xls HTML con imágenes) ========== */
function exportExcel(){
  // Para que Excel muestre imágenes sin librerías pagas, generamos una tabla HTML y la bajamos como .xls
  const rows = (state.view.length ? state.view : state.productos).map(p=>`
    <tr>
      <td><img src="${p.imagen}" width="80" height="60" style="object-fit:cover;border-radius:6px"/></td>
      <td>${escapeHTML(p.nombre)}</td>
      <td>${escapeHTML(p.categoria)}</td>
      <td>${escapeHTML(p.descripcion)}</td>
      <td>${numberToMoney(p.precio)}</td>
    </tr>
  `).join('');

  const html = `
    <html>
    <head><meta charset="UTF-8"></head>
    <body>
      <table border="1" cellspacing="0" cellpadding="5">
        <thead>
          <tr style="background:#f0e7e1">
            <th>Imagen</th><th>Nombre</th><th>Categoría</th><th>Descripción</th><th>Precio</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </body>
    </html>
  `;
  const blob = new Blob([html], {type: 'application/vnd.ms-excel'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'carta_tilo.xls';
  document.body.appendChild(a);
  a.click();
  a.remove();
}
function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

</script>
</body>
</html>
